{% extends "base.html" %}
{% block title %}In√≠cio{% endblock %}
{% load l10n %}

{% block content %}
<h1 class="card-resumo">Resumo {{ mes_atual_nome }}</h1>

<!-- cards principais -->
<div class="dashboard-grid">

  <div class="card card-resumo card-resumo-renda">
    <h2>Renda</h2>
    <p class="card-resumo-valor">R$ {{ total_renda|floatformat:2|localize }}</p>
    <p class="card-resumo-label">Entradas de dinheiro</p>
    <a href="{% url 'rendamensal:cadastro_renda' %}" class="btn btn-sm">Ver detalhes</a>
  </div>
</div>

<div class="dashboard-grid">
  <div class="card card-resumo card-resumo-despesas">
    <h2>Despesas</h2>
    <p class="card-resumo-valor">R$ {{ total_despesas|floatformat:2|localize }}</p>
    <p class="card-resumo-label">Gastos gerais</p>
    <a href="{% url 'despesas:lista_despesas' %}" class="btn btn-sm">Ver detalhes</a>
  </div>
</div>

<!-- üîî ALERTAS DE DESPESAS -->
<div class="card" style="margin-top:16px;">
  <h2>Alertas de Despesas</h2>
  <p class="card-resumo-label">Despesas a vencer, vencendo hoje e vencidas.</p>

  <div class="dashboard-grid" style="grid-template-columns: repeat(3, minmax(0,1fr)); gap:16px;">

    <!-- VENCIDAS -->
    <div class="card" style="border-color:#ff6b6b;">
      <h3 style="color:#ff6b6b; text-align:center;">Vencidas</h3>
      {% if despesas_vencidas %}
        <ul class="list-unstyled">
          {% for d in despesas_vencidas %}
            <li>
              üßæ {{ d.nome }} ‚Äî R$ {{ d.valor|floatformat:2|localize }}
              ‚Äî {{ d.data_vencimento|date:"d/m/Y" }}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="card-resumo-label">Sem despesas vencidas üéâ</p>
      {% endif %}
    </div>

    <!-- VENCEM HOJE -->
    <div class="card" style="border-color:#fdcb6e;">
      <h3 style="color:#fdcb6e; text-align:center;">Vencem hoje</h3>
      {% if despesas_vence_hoje %}
        <ul class="list-unstyled">
          {% for d in despesas_vence_hoje %}
            <li>
              üßæ {{ d.nome }} ‚Äî R$ {{ d.valor|floatformat:2|localize  }} ‚Äî hoje
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="card-resumo-label">Nenhuma despesa vencendo hoje.</p>
      {% endif %}
    </div>

    <!-- PR√ìXIMOS DIAS -->
    <div class="card" style="border-color:#00b894;">
      <h3 style="color:#00b894; text-align:center;">Pr√≥ximos dias</h3>
      {% if despesas_proximas %}
        <ul class="list-unstyled">
          {% for d in despesas_proximas %}
            <li>
              üßæ {{ d.nome }} ‚Äî R$ {{ d.valor|floatformat:2|localize  }}
              ‚Äî {{ d.data_vencimento|date:"d/m" }}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="card-resumo-label">Sem despesas pr√≥ximas a vencer.</p>
      {% endif %}
    </div>

  </div>
</div>  

<div class="dashboard-grid">
  <div class="card card-resumo card-resumo-financiamentos">
    <h2>Financiamentos</h2>
    <p class="card-resumo-valor">R$ {{ total_financiamentos|floatformat:2|localize }}</p>
    <p class="card-resumo-label">Parcelas e d√≠vidas</p>
    <a href="{% url 'financiamentos:lista_financiamentos' %}" class="btn btn-sm">Ver detalhes</a>
  </div>
</div>
 
<!-- üîî ALERTAS DE FINANCIAMENTOS -->
<div class="card" style="margin-top:16px;">
  <h2>Alertas de Financiamentos</h2>
  <p class="card-resumo-label">Parcelas de financiamentos a observar.</p>

  <div class="dashboard-grid" style="grid-template-columns: repeat(3, minmax(0,1fr)); gap:16px;">

    <!-- VENCIDOS -->
    <div class="card" style="border-color:#ff6b6b;">
      <h3 style="color:#ff6b6b; text-align:center;">Vencidos</h3>
      {% if financ_vencidos %}
        <ul class="list-unstyled">
          {% for f in financ_vencidos %}
            <li>
              üè¶ {{ f.credor }} ‚Äî R$ {{ f.valor_parcela|floatformat:2|localize  }}
              ‚Äî {{ f.data_vencimento|date:"d/m/Y" }}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="card-resumo-label">Sem financiamentos vencidos üéâ</p>
      {% endif %}
    </div>

    <!-- VENCEM HOJE -->
    <div class="card" style="border-color:#fdcb6e;">
      <h3 style="color:#fdcb6e; text-align:center;">Vencem hoje</h3>
      {% if financ_vence_hoje %}
        <ul class="list-unstyled">
          {% for f in financ_vence_hoje %}
            <li>
              üè¶ {{ f.credor }} ‚Äî R$ {{ f.valor_parcela|floatformat:2|localize  }} ‚Äî hoje
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="card-resumo-label">Nenhuma parcela vencendo hoje.</p>
      {% endif %}
    </div>

    <!-- PR√ìXIMOS DIAS -->
    <div class="card" style="border-color:#00b894;">
      <h3 style="color:#00b894; text-align:center;">Pr√≥ximos dias</h3>
      {% if financ_proximos %}
        <ul class="list-unstyled">
          {% for f in financ_proximos %}
            <li>
              üè¶ {{ f.credor }} ‚Äî R$ {{ f.valor_parcela|floatformat:2|localize  }}
              ‚Äî {{ f.data_vencimento|date:"d/m" }}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="card-resumo-label">Sem parcelas pr√≥ximas a vencer.</p>
      {% endif %}
    </div>

  </div>
</div>

<!-- saldo geral -->
<div class="card">
  <h2>Saldo do m√™s</h2>
  <p>
    {% if saldo >= 0 %}
      <span style="color:#00b894; font-size:1.4rem; font-weight:bold;">
        R$ {{ saldo|floatformat:2|localize }}
      </span>
      <span> ‚Ä¢ Situa√ß√£o positiva üôÇ</span>
    {% else %}
      <span style="color:#ff7675; font-size:1.4rem; font-weight:bold;">
        R$ {{ saldo|floatformat:2|localize  }}
      </span>
      <span> ‚Ä¢ Aten√ß√£o: gastos maiores que a renda üò¨</span>
    {% endif %}
  </p>
</div>

<!-- gr√°fico de sa√∫de financeira -->
<div class="card">
  <h2>Sa√∫de financeira ao longo dos meses</h2>
  <p class="card-resumo-label">
    Compare a evolu√ß√£o de renda, despesas, financiamentos e saldo ao longo do ano.
  </p>
  <canvas id="graficoSaude" height="120"></canvas>
</div>

<!-- script do gr√°fico -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const labels = {{ labels_json|default:"[]"|safe }};
  const dadosRenda = {{ renda_por_mes_json|default:"[]"|safe }};
  const dadosDespesas = {{ despesas_por_mes_json|default:"[]"|safe }};
  const dadosFinanciamentos = {{ financiamentos_por_mes_json|default:"[]"|safe }};
  const dadosSaldo = {{ saldo_por_mes_json|default:"[]"|safe }};

  const ctx = document.getElementById('graficoSaude').getContext('2d');

  new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Renda',
          data: dadosRenda,
          borderColor: '#00b894',
          backgroundColor: 'rgba(0,184,148,0.2)',
          tension: 0.3
        },
        {
          label: 'Despesas',
          data: dadosDespesas,
          borderColor: '#ff7675',
          backgroundColor: 'rgba(255,118,117,0.2)',
          tension: 0.3
        },
        {
          label: 'Financiamentos',
          data: dadosFinanciamentos,
          borderColor: '#0984e3',
          backgroundColor: 'rgba(9,132,227,0.2)',
          tension: 0.3
        },
        {
          label: 'Saldo',
          data: dadosSaldo,
          borderColor: '#fdcb6e',
          backgroundColor: 'rgba(253,203,110,0.2)',
          borderDash: [5, 5],
          tension: 0.3
        },
      ]
    },
    options: {
      plugins: {
        legend: {
          labels: {
            color: '#ffffff'
          }
        }
      },
      scales: {
        x: {
          ticks: { color: '#ffffff' },
          grid: { color: 'rgba(255,255,255,0.05)' }
        },
        y: {
          ticks: { color: '#ffffff' },
          grid: { color: 'rgba(255,255,255,0.05)' }
        }
      }
    }
  });
</script>
{% endblock %}